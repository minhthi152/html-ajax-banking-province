<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/sweetalert/v2/sweetalert2.css">
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />

</head>

<body>

    <div class="table-title">
        <div class="row">
            <div class="col-sm-5">
                <h1>List of customers</h1>
            </div>
            <div class="col-sm-7">
                <a class="btn btn-outline-light create" id="btnCreateCustomer">
                    <i class="fa fa-plus-square-o" aria-hidden="true"></i>
                    <span>Add New Customer</span>
                </a>
                <a href="/transfers.html" class="btn btn-outline-light"><i class="fa fa-history" aria-hidden="true"></i>
                    <span>Transfer money Information</span></a>
            </div>
        </div>
    </div>

    <div>
        <table class="table table-hover" id="tbCustomer">
            <thead>
                <tr>
                    <th></th>
                    <th>#</th>
                    <th>Full name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Balance</th>
                    <th>Province</th>
                    <th>District</th>
                    <th>Ward</th>
                    <th>Address</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>


    <div class="footer">
        <div>

        </div>
    </div>

    <!-- Modal Create Customer -->

    <div id="modalCreate" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-modal="true" role="dialog">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Customer information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="modal-alert-danger hide"></div>
                    <form id="frmCreate">
                        <fieldset class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Full name</label>
                                <input type="text" class="form-control" id="fullName" name="fullName">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Email</label>
                                <input type="text" class="form-control" id="email" name="email">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="phone" name="phone">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Province</label>
                                <select class="form-select" id="province" name="province">

                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">District</label>
                                <select class="form-select" id="district" name="district">


                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Ward</label>
                                <select class="form-select" id="ward" name="ward">

                                    <!-- <option value="31273">Xã Đông Hiệp</option> -->
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Address</label>
                                <input type="text" class="form-control" id="address" name="address">
                            </div>
                        </fieldset>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="btnCreate" class="btn btn-outline-primary">
                        <i class="fa fa-plus" aria-hidden="true"></i>
                        Create customer
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Update Customer -->
    <div id="modalUpdate" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-modal="true" role="dialog" ;>
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Customer information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="modal-alert-danger hide" style="display: none;"></div>
                    <form id="frmUpdate" method="post" novalidate="novalidate">
                        <fieldset class="row g-3">
                            <div class="col-md-4">
                                <input type="hidden" class="form-control" id="customerIdUp" name="customerIdUp">
                                <label class="form-label">Full name</label>
                                <input type="text" class="form-control" id="fullNameUp" name="fullNameUp">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="emailUp" name="emailUp">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="phoneUp" name="phoneUp">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Province</label>
                                <select class="form-select" id="provinceUp" name="provinceUp">

                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">District</label>
                                <select class="form-select" id="districtUp" name="districtUp">

                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Ward</label>
                                <select class="form-select" id="wardUp" name="wardUp">

                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Address</label>
                                <input type="text" class="form-control" id="addressUp" name="addressUp">
                            </div>
                        </fieldset>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" id="btnUpdate" class="btn btn-outline-secondary">
                        <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                        Update customer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal deposit -->
    <div id="modalDeposit" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Deposit money into customer's account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="modal-alert-danger hide"></div>
                    <form id="frmDeposit" method="post">
                        <fieldset class="row g-3">
                            <div class="mb-3 col-md-6">
                                <div class="form-group row">
                                    <label class="col-sm-12 col-form-label">Customer ID</label>
                                    <div class="col-sm-12">
                                        <input type="text" id="customerIdDep" name="customerIdDep" class="form-control"
                                            readonly />
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3 col-md-6">
                                <div class="form-group row">
                                    <label class="col-sm-12 col-form-label">Full Name</label>
                                    <div class="col-sm-12">
                                        <input type="text" class="form-control" id="fullNameDep" name="fullNameDep"
                                            readonly />
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3 col-md-6">
                                <div class="form-group row">
                                    <label class="col-sm-12 col-form-label">Current balance ($)</label>
                                    <div class="col-sm-12">
                                        <input type="text" class="form-control num-space" id="balanceDep"
                                            name="balanceDep" readonly />
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3 col-md-6">
                                <div class="form-group row">
                                    <label class="col-sm-12 col-form-label">Transaction Amount ($)</label>
                                    <div class="col-sm-12">
                                        <input type="text" class="form-control num-space" id="transactionAmountDep"
                                            name="transactionAmountDep" />
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="btnDeposit" class="btn btn-outline-success">
                        <i class="fa fa-plus" aria-hidden="true"></i>
                        Deposit
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal withdraw -->
    <div id="modalWithdraw" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Withdraw money from the customer's account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="modal-alert-danger hide"></div>
                    <form id="frmWithdraw">
                        <fieldset class="row g-3">
                            <div class="mb-3 col-md-6">
                                <div class="form-group row">
                                    <label class="col-sm-12 col-form-label">Customer ID</label>
                                    <div class="col-sm-12">
                                        <input type="text" id="customerIdWd" name="customerIdWd" class="form-control"
                                            readonly />
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3 col-md-6">
                                <div class="form-group row">
                                    <label class="col-sm-12 col-form-label">Full Name</label>
                                    <div class="col-sm-12">
                                        <input type="text" class="form-control" id="fullNameWd" name="fullNameWd"
                                            readonly />
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3 col-md-6">
                                <div class="form-group row">
                                    <label class="col-sm-12 col-form-label">Current balance ($)</label>
                                    <div class="col-sm-12">
                                        <input type="number" class="form-control num-space" id="balanceWd"
                                            name="balanceWd" readonly />
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3 col-md-6">
                                <div class="form-group row">
                                    <label class="col-sm-12 col-form-label">Transaction Amount ($)</label>
                                    <div class="col-sm-12">
                                        <input type="number" class="form-control num-space" id="transactionAmountWd"
                                            name="transactionAmountWd" />
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" id="btnWithdraw" class="btn btn-outline-warning">
                        <i class="fa fa-minus" aria-hidden="true"></i>
                        Withdraw
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal transfer -->
    <div id="modalTransfer" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Transfer money Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="modal-alert-danger hide"></div>
                    <form id="frmTransfer" method="post">
                        <fieldset class="row mt-3 g-3">
                            <div class="form-group row">
                                <div class="mb-3 col-md-4">
                                    <label class="col-sm-12 col-form-label">Sender ID</label>
                                    <div class="col-sm-12">
                                        <input type="text" class="form-control" id="senderIdTrf" name="senderIdTrf"
                                            readonly>
                                    </div>
                                </div>
                                <div class="mb-3 col-md-4">
                                    <label class="col-sm-12 col-form-label">Sender Name</label>
                                    <div class="col-sm-12">
                                        <input type="text" class="form-control" id="senderNameTrf" name="senderNameTrf"
                                            readonly>
                                    </div>
                                </div>
                                <div class="mb-3 col-md-4">
                                    <label class="col-sm-12 col-form-label">Email</label>
                                    <div class="col-sm-12">
                                        <input type="email" class="form-control" id="emailTrf" name="emailTrf" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="mb-3 col-md-6">
                                    <label class="col-sm-12 col-form-label">Sender balance</label>
                                    <div class="col-sm-12">
                                        <input type="number" class="form-control num-space" id="balanceTrf"
                                            name="balanceTrf" readonly>
                                    </div>
                                </div>

                                <div class="mb-3 col-md-6">
                                    <label class="col-sm-12 col-form-label">Recipient Name</label>
                                    <div class="col-sm-12">
                                        <select class="form-select" id="recipientIdTrf" name="recipientIdTrf">
                                            <!-- <option>Thi</option>
                                            <option>Thii</option>                                    -->
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="mb-3 col-md-4">
                                    <label class="col-sm-12 col-form-label">Transfer Amount ($)</label>
                                    <div class="col-sm-12">
                                        <input type="number" class="form-control num-space" id="transferAmountTrf"
                                            name="transferAmountTrf">
                                    </div>
                                </div>
                                <div class="mb-3 col-md-4">
                                    <label class="col-sm-12 col-form-label">Fees (%)</label>
                                    <div class="col-sm-12">
                                        <input type="number" class="form-control num-space" id="feesTrf" name="feesTrf"
                                            value="10" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 col-md-4">
                                    <label class="col-sm-12 col-form-label">Total amount of transaction ($)</label>
                                    <div class="col-sm-12">
                                        <input type="number" class="form-control num-space" id="transactionAmountTrf"
                                            name="transactionAmountTrf" readonly>
                                    </div>
                                </div>
                            </div>
                        </fieldset>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" id="btnTransfer" class="btn btn-outline-primary">
                        <i class="fa fa-exchange" aria-hidden="true"></i>
                        Transfer
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script src="/assets/js/jquery-3.6.0.min.js"></script>
    <script src="/assets/js/jquery.validate.min.js"></script>
    <script src="/assets/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/sweetalert/v2/sweetalert2.js"></script>
    <script src="/assets/js/app.js"></script>

    <script>
        // ================================================================================================
        // ===================================== GENERAL HANDLING =========================================
        // ================================================================================================

        let locationRegion = new LocationRegion();
        let customer = new Customer();
        let deposit = new Deposit();
        let withdraw = new Withdraw();
        let transfer = new Transfer();
        let sender = new Customer();
        let recipient = new Customer();
        let transferDTO = new TransferDTO();

        let provinces = [];
        let districts = [];
        let wards = [];
        let customers = [];

        function handleGroupShowModal() {
            handleShowUpdate();
            handleConfirmDelete();
            handleShowDeposit();
            handleShowWithdraw();
            handleShowTransfer();
            handleSelectRow();


        }

        function unbindAll() {
            $('.update').off()
            $('.delete').off()
            $('.deposit').off()
            $('.withdraw').off()
            $('.transfer').off()
        }

        function getCustomerById(customerId) {

            return $.ajax({
                    "type": "GET",
                    "url": "http://localhost:3000/customers/" + customerId
                })
                .done((data) => {
                    customer = data;

                })
                .fail((error) => {
                    App.SweetAlert.showAlertError('Invalid customer ID')
                })

        }

        // ================================================================================================
        // ===================================== LOAD CUSTOMERS ===========================================
        // ================================================================================================
        function loadCustomers() {

            $.ajax({
                    type: "GET",
                    headers: {
                        "Content-Type": "Application/json",
                        "Accept": "Application/json"
                    },
                    url: "http://localhost:3000/customers?deleted=0"
                })
                .done((data) => {
                    $.each(data, (i, item) => {
                        customer = item;
                        locationRegion = customer.locationRegion;

                        let str = `
                        <tr id="tr_${customer.id}">
                            <td> 
                                <span class="select-tab unselected"></span>
                            </td>
                            <td id="td_${customer.id}">${customer.id}</td>
                            <td>${customer.fullName}</td>
                            <td>${customer.email}</td>
                            <td>${customer.phone}</td>
                            <td>${customer.balance}</td>
                            <td>${locationRegion.provinceName}</td>
                            <td>${locationRegion.districtName}</td>
                            <td>${locationRegion.wardName}</td>
                            <td>${locationRegion.address}</td>                    
                        </tr>
                    `;

                        $('#tbCustomer tbody').prepend(str);


                    })
                    handleGroupShowModal();
                })
        }

        loadCustomers();

        // ================================================================================================ 
        // ===================================== SHOW ACTION OPTION ========================================
        // ================================================================================================ 

        function handleSelectRow() {
            $('#tbCustomer tr').on("click", function () {

                let customerId = this.id.replace("tr_", "");

                $('#tbCustomer span').addClass("unselected").removeClass("selected");
                $('#tr_' + customerId + " span").addClass("selected").removeClass("unselected");


                getCustomerById(customerId).then(function () {
                    let actionStr = `
                        <div>
                            <button type="button" class="btn btn-secondary update" data-id="${customerId}">
                                <i class="fa-solid fa-pencil"></i>
                                Update
                            </button>
                            <button type="button" class="btn btn-success deposit" data-id="${customerId}">
                                <i class="fa-solid fa fa-plus" aria-hidden="true"></i>
                                Deposit
                            </button>
                            <button type="button" class="btn btn-dark withdraw" data-id="${customerId}">
                                <i class="fa-solid fa fa-minus" aria-hidden="true"></i>
                                Withdraw 
                            </button>
                            <button type="button" class="btn btn-primary transfer" data-id="${customerId}">
                                <i class="fa fa-exchange"></i>
                                Transfer
                            </button>
                            <button type="button" class="btn btn-danger deactive" data-id="${customerId}">
                                <i class="fa fa-ban" aria-hidden="true"></i>
                                Deactive
                            </button> 
                        </div>
                        `;

                    $('.footer > div').replaceWith(actionStr);
                    handleGroupShowModal();
                })
            })
        }

        // ================================================================================================ 
        // ===================================== DEACTIVE CUSTOMER ========================================
        // ================================================================================================ 

        function handleConfirmDelete() {
            $('.deactive').on('click', function () {
                let customerId = $(this).data('id');

                App.SweetAlert.showConfirmDelete()
                    .then((result) => {
                        if (result.isConfirmed) {
                            getCustomerById(customerId).then(() => {
                                doDeactive(customerId);
                            })
                        }
                    })
            })
        }

        function doDeactive(customerId) {
            customer.deleted = 1;

            $.ajax({
                    type: "PUT",
                    url: "http://localhost:3000/customers/" + customerId,
                    data: customer
                })
                .done((data) => {

                    console.log(customer);

                    $('#tr_' + customerId).remove();
                    App.SweetAlert.showAlertSuccess('The customer has been deactived');
                })
                .fail((error) => {
                    App.SweetAlert.showAlertError('Deactive customer fail');
                });
        }


        // ================================================================================================ 
        // ===================================== CREATE CUSTOMER ==========================================
        // ================================================================================================ 

        // ------ Show create form ------ 

        function getProvince() {
            return $.ajax({
                    type: "GET",
                    url: "https://vapi.vnappmob.com/api/province/",
                })
                .done((data) => {
                    let provinces = data.results;
                    $('#province').html("");

                    $.each(provinces, (i, item) => {

                        let provinceStr = `
                        <option value="${item.province_id}">${item.province_name}</option>
                    `;
                        $('#province').prepend(provinceStr);
                    });
                })
                .fail((error) => {
                    alert('fail');
                })
        }

        function getDistrict(provinceId) {
            return $.ajax({
                    type: "GET",
                    url: "https://vapi.vnappmob.com/api/province/district/" + provinceId,
                })
                .done((data) => {
                    let districts = data.results;
                    $('#district').html("");

                    $.each(districts, (i, item) => {
                        let districtStr = `
                        <option value="${item.district_id}">${item.district_name}</option>
                    `;
                        $('#district').prepend(districtStr);
                    });
                })
                .fail((error) => {
                    alert('fail');
                })

        }

        function getWard(wardId) {
            return $.ajax({
                    type: "GET",
                    url: "https://vapi.vnappmob.com/api/province/ward/" + wardId,
                })
                .done((data) => {
                    let wards = data.results;
                    $('#ward').html("");

                    $.each(wards, (i, item) => {
                        let wardStr = `
                        <option value="${item.ward_id}">${item.ward_name}</option>
                    `;
                        $('#ward').prepend(wardStr);
                    });
                })
                .fail((error) => {
                    alert('fail');
                })
        }


        $('#btnCreateCustomer').on('click', function () {

            $.ajax({
                    "type": "GET",
                    "url": "http://localhost:3000/customers/"
                })
                .done((data) => {
                    $('#fullName').val("");
                    $('#email').val("");
                    $('#phone').val("");
                    $('#address').val("");

                })
                .fail((error) => {
                    alert('fail');
                });

            $('#modalCreate').modal('show');
        })

        getProvince().then(() => {
            changeProvince();
        });

        $('#province').on("change", () => {
            changeProvince();
        })

        $('#district').on("change", () => {
            changeDistrict();
        })


        function changeProvince() {
            let provinceId = $('#province').val();

            getDistrict(provinceId).then(() => {
                let districtId = $('#district').val();
                getWard(districtId);
            });
        }

        function changeDistrict() {
            let districtId = $('#district').val();
            getWard(districtId);
        }
        // ------- Create customer -------

        function doCreate() {

            let provinceId = $('#province').val();
            let provinceName = $('#province option:selected').text();
            let districtId = $('#district').val();
            let districtName = $('#district option:selected').text();
            let wardId = $('#ward').val();
            let wardName = $('#ward option:selected').text();
            let address = $('#address').val();

            delete locationRegion.id;
            locationRegion.provinceId = provinceId;
            locationRegion.provinceName = provinceName;
            locationRegion.districtId = districtId;
            locationRegion.districtName = districtName;
            locationRegion.wardId = wardId;
            locationRegion.wardName = wardName;
            locationRegion.address = address;

            let fullName = $('#fullName').val();
            let email = $('#email').val();
            let phone = $('#phone').val();

            delete customer.id;
            customer.fullName = fullName;
            customer.email = email;
            customer.phone = phone;
            customer.locationRegion = locationRegion;
            customer.balance = 0;
            console.log(customer);

            let isEmailExisted = 0;
            $.ajax({
                    type: "GET",
                    headers: {
                        "Content-Type": "Application/json",
                        "Accept": "Application/json"
                    },
                    url: "http://localhost:3000/customers"
                })
                .done((data) => {
                    $.each(data, (i, item) => {                 
                        if (email.toLowerCase() == item.email.toLowerCase()) {
                            isEmailExisted = 1;
                        };
                    })
                    console.log(isEmailExisted);

                    // Excute create if email has not been used

                    if (isEmailExisted == 0) {
                        $.ajax({
                                "headers": {
                                    "type": "application/json",
                                    "content-type": "application/json"
                                },
                                "type": "POST",
                                "url": "http://localhost:3000/customers",
                                "data": JSON.stringify(customer)
                            })
                            .done((item) => {
                                customer = item;
                                locationRegion = customer.locationRegion;

                                let str = `
                                <tr id="tr_${customer.id}">
                                    <td> 
                                        <span class="select-tab unselected"></span>
                                    </td>
                                    <td>${customer.id}</td>
                                    <td>${customer.fullName}</td>
                                    <td>${customer.email}</td>
                                    <td>${customer.phone}</td>                       
                                    <td>${customer.balance}</td>
                                    <td>${locationRegion.provinceName}</td>
                                    <td>${locationRegion.districtName}</td>
                                    <td>${locationRegion.wardName}</td>
                                    <td>${locationRegion.address}</td>                   
                                </tr>
                            `;
                                $('#tbCustomer tbody').prepend(str);

                                unbindAll();
                                handleGroupShowModal();
                                $('#modalCreate').modal('hide');
                                App.SweetAlert.showAlertSuccess("New customer created successfully.")
                            })

                    } else {
                        App.SweetAlert.showAlertError("Email has already been used.")
                    }

                })


        }

        $('#btnCreate').on('click', () => {
            $('#frmCreate').submit();
        })

        $('#frmCreate').validate({
            rules: {
                fullName: {
                    required: true
                },
                email: {
                    required: true
                },
                phone: {
                    required: true
                },
                address: {
                    required: true
                }
            },
            messages: {
                fullName: {
                    required: "Please fill in customer's full name."
                },
                email: {
                    required: "Please fill in customer's email.",
                    uniqueEmail: "This email has been used. Please try another one!"
                },
                phone: {
                    required: "Please fill in customer's phone number."
                },
                address: {
                    required: "Please fill in customer's address."
                }
            },
            submitHandler: function () {
                doCreate();
            }
        })

        // ================================================================================================
        // ============================================ UPDATE CUSTOMER ===================================
        // ================================================================================================

        function getProvinceUp() {
            return $.ajax({
                    type: "GET",
                    url: "https://vapi.vnappmob.com/api/province/",
                })
                .done((data) => {
                    let provinces = data.results;
                    $('#provinceUp').html("");

                    $.each(provinces, (i, item) => {

                        let provinceStr = `
                        <option value="${item.province_id}">${item.province_name}</option>
                    `;
                        $('#provinceUp').prepend(provinceStr);
                    });
                })
                .fail((error) => {
                    alert('fail');
                })
        }

        function getDistrictUp(provinceId) {
            return $.ajax({
                    type: "GET",
                    url: "https://vapi.vnappmob.com/api/province/district/" + provinceId,
                })
                .done((data) => {
                    let districts = data.results;
                    $('#districtUp').html("");

                    $.each(districts, (i, item) => {
                        let districtStr = `
                        <option value="${item.district_id}">${item.district_name}</option>
                    `;
                        $('#districtUp').prepend(districtStr);
                    });
                })
                .fail((error) => {
                    alert('fail');
                })

        }

        function getWardUp(wardId) {
            return $.ajax({
                    type: "GET",
                    url: "https://vapi.vnappmob.com/api/province/ward/" + wardId,
                })
                .done((data) => {
                    let wards = data.results;
                    $('#wardUp').html("");

                    $.each(wards, (i, item) => {
                        let wardStr = `
                        <option value="${item.ward_id}">${item.ward_name}</option>
                    `;
                        $('#wardUp').prepend(wardStr);
                    });
                })
                .fail((error) => {
                    alert('fail');
                })
        }

        getProvinceUp().then(() => {
            changeProvinceUp();
        });

        $('#provinceUp').on("change", () => {
            changeProvinceUp();
        })

        $('#districtUp').on("change", () => {
            changeDistrictUp();
        })

        function changeProvinceUp() {
            let provinceId = $('#provinceUp').val();
            getDistrictUp(provinceId).then(() => {
                let districtId = $('#districtUp').val();
                getWardUp(districtId);
            });
        }

        function changeDistrictUp() {
            let districtId = $('#districtUp').val();
            getWardUp(districtId);
        }


        function handleShowUpdate() {

            $('.update').on('click', function () {

                let id = $(this).data('id');
                getCustomerById(id).then(function () {
                    $.ajax({
                            "type": "GET",
                            "url": "http://localhost:3000/customers/" + id
                        })
                        .done((data) => {
                            customer = data;
                            locationRegion = customer.locationRegion;
                            console.log(customer);

                            $('#modalUpdate').modal('show');

                            $('#customerIdUp').val(customer.id);
                            $('#fullNameUp').val(customer.fullName);
                            $('#emailUp').val(customer.email);
                            $('#phoneUp').val(customer.phone);
                            $('#provinceUp').val(locationRegion.provinceId);
                            $('#districtUp').val(locationRegion.districtId);
                            $('#wardUp').val(locationRegion.wardId);


                            $.ajax({
                                    type: "GET",
                                    url: "https://vapi.vnappmob.com/api/province/",
                                })
                                .done((data) => {
                                    let provinces = data.results;
                                    $('#provinceUp').html("");
                                    let provinceStr;
                                    $.each(provinces, (i, item) => {
                                        if (item.province_id == locationRegion
                                            .provinceId) {
                                            provinceStr = `
                                        <option value="${locationRegion.provinceId}"selected>${locationRegion.provinceName}</option>
                                        `;
                                        } else {
                                            provinceStr = `            
                                        <option value="${item.province_id}">${item.province_name}</option>
                                    `;
                                        }
                                        $('#provinceUp').prepend(provinceStr);
                                    });
                                })
                                .fail((error) => {
                                    alert('fail');
                                })
                            getDistrictUp(locationRegion.provinceId).then(function () {
                                getWardUp(locationRegion.districtId);
                            })

                        })
                        .fail((error) => {
                            alert('fail');
                        })
                })

            })
        }

        $('#frmUpdate').validate({
            rules: {
                fullNameUp: {
                    required: true
                },
                emailUp: {
                    required: true,
                    emailNotExistsEdit: true
                },
                phoneUp: {
                    required: true
                },
                addressUp: {
                    required: true
                }
            },
            messages: {
                fullNameUp: {
                    required: "Please fill in customer's full name."
                },
                emailUp: {
                    required: "Please fill in customer's email."
                },
                phoneUp: {
                    required: "Please fill in customer's phone number."
                },
                addressUp: {
                    required: "Please fill in customer's address."
                }
            },
            submitHandler: function () {
                doUpdate();
            }
        })

        $('#btnUpdate').on('click', () => {
            $('#frmUpdate').submit();
        })

        function doUpdate() {
            let customerId = $('#customerIdUp').val();
            console.log(customerId);

            let provinceId = $('#provinceUp').val();
            let provinceName = $('#provinceUp option:selected').text();
            let districtId = $('#districtUp').val();
            let districtName = $('#districtUp option:selected').text();
            let wardId = $('#wardUp').val();
            let wardName = $('#wardUp option:selected').text();
            let address = $('#addressUp').val();

            delete locationRegion.id;
            locationRegion.provinceId = provinceId;
            locationRegion.provinceName = provinceName;
            locationRegion.districtId = districtId;
            locationRegion.districtName = districtName;
            locationRegion.wardId = wardId;
            locationRegion.wardName = wardName;
            locationRegion.address = address;

            customer.id = customerId
            customer.fullName = $('#fullNameUp').val();
            let email =  $('#emailUp').val();
            customer.email = $('#emailUp').val();
            customer.phone = $('#phoneUp').val();
            customer.address = $('#addressUp').val();
            customer.locationRegion = locationRegion;

            // let isEmailExisted = 0;
            // let currentEmails = [];
            // $.ajax({
            //     type: "GET",
            //     headers:{
            //         "Content-Type": "Application/json",
            //         "Accept":  "Application/json"
            //     },
            //     url: "http://localhost:3000/customers"
            // })
            // .done((data) => {               
            //     $.each(data, (i, item) => { 
            //         currentEmails.push(item.email.toLowerCase());                                                
            //     }) 
            //     currentEmails = currentEmails.filter(e => e != email);
            //     console.log(currentEmails);

            //     $.each(currentEmails, (i, item) => { 
            //         if(email == item.email){
            //             isEmailExisted = 1;
            //         };                                               
            //     })         
            //     console.log(isEmailExisted); 

            //     // Excute create if email has not been used

            //     if(isEmailExisted == 0){
                    $.ajax({
                        headers: {
                            "type": "application/json",
                            "content-type": "application/json"
                        },
                        type: "PUT",
                        url: "http://localhost:3000/customers/" + customerId,
                        data: JSON.stringify(customer)
                    })
                    .done((item) => {
                        customer = item;
                        locationRegion = customer.locationRegion;
                        console.log(customer);

                        let currentRow = $('#tr_' + customer.id);
                        let updateRow = `
                            <tr id="tr_${customer.id}">
                                <td> 
                                    <span class="select-tab unselected"></span>
                                </td>
                                <td>${customer.id}</td>
                                <td>${customer.fullName}</td>
                                <td>${customer.email}</td>
                                <td>${customer.phone}</td>                       
                                <td>${customer.balance}</td>
                                <td>${locationRegion.provinceName}</td>
                                <td>${locationRegion.districtName}</td>
                                <td>${locationRegion.wardName}</td>
                                <td>${locationRegion.address}</td>                   
                            </tr>
                        `;

                        currentRow.replaceWith(updateRow);
                        $('#modalUpdate').modal('hide');

                        App.SweetAlert.showAlertSuccess("Updated successfully!");

                        unbindAll();
                        handleGroupShowModal();

                    })
                    .fail((error) => {
                        App.SweetAlert.showAlertError("Update fail!")
                    })

                    
            //     }else{
            //         App.SweetAlert.showAlertError("Email has already been used.")               
            //     }
                                                
            // })    
            
        }

        // ================================================================================================
        // ============================================ DEPOSIT ===========================================
        // ================================================================================================

        function handleShowDeposit() {
            $('.deposit').on('click', function () {
                let id = $(this).data('id');
                console.log(id);

                $.ajax({
                        "type": "GET",
                        "url": "http://localhost:3000/customers/" + id
                    })
                    .done((data) => {

                        $('#modalDeposit').modal('show');

                        $('#customerIdDep').val(data.id);
                        $('#fullNameDep').val(data.fullName);
                        $('#balanceDep').val(data.balance);

                    })
                    .fail((error) => {
                        alert('fail');
                    })
            })
        }

        $('#frmDeposit').validate({
            rules: {
                transactionAmountDep: {
                    required: true,
                    number: true,
                    greaterThanEqual: 50,
                    lessThanEqual: 1000000000
                }
            },
            messages: {
                transactionAmountDep: {
                    required: "Please enter transaction amount.",
                    number: "Please enter only digit",
                    greaterThanEqual: "Deposit money must be greater than 50$",
                    lessThanEqual: "Deposit money must be less than $1 000 000 000"
                }
            },
            submitHandler: function () {
                doDeposit();
            }
        })

        $('#btnDeposit').on('click', () => {
            $('#frmDeposit').submit();
        })

        function doDeposit() {
            let customerId = $('#customerIdDep').val();
            let transactionAmount = +$('#transactionAmountDep').val();

            console.log("deposit clicked");

            delete deposit.id;
            deposit.customerId = customerId;
            deposit.transactionAmount = transactionAmount;
            deposit.createdAt = new Date();
            deposit.createdBy = 1;
            deposit.updatedAt = new Date();
            deposit.updatedBy = 1;
            deposit.isDeleted = 0;

            $.ajax({
                    type: "POST",
                    url: "http://localhost:3000/deposits",
                    data: deposit
                })
                .done((data) => {
                    console.log(data);
                })
                .fail((err) => {
                    alert("Deposit fail")
                })


            getCustomerById(customerId).then(function () {
                customer.balance = Number(customer.balance) + Number(transactionAmount);
                $.ajax({
                        headers: {
                            "type": "application/json",
                            "content-type": "application/json"
                        },
                        type: "PUT",
                        url: "http://localhost:3000/customers/" + customerId,
                        data: JSON.stringify(customer)
                    })
                    .done((item) => {
                        customer = item;
                        locationRegion = customer.locationRegion;
                        console.log(customer.balance);

                        let currentRow = $('#tr_' + item.id);
                        let updateRow = `
                    <tr id="tr_${customer.id}">
                        <td> 
                            <span class="select-tab unselected"></span>
                        </td>
                        <td>${customer.id}</td>
                        <td>${customer.fullName}</td>
                        <td>${customer.email}</td>
                        <td>${customer.phone}</td>                       
                        <td>${customer.balance}</td>
                        <td>${locationRegion.provinceName}</td>
                        <td>${locationRegion.districtName}</td>
                        <td>${locationRegion.wardName}</td>
                        <td>${locationRegion.address}</td>                   
                    </tr>
                `;

                        currentRow.replaceWith(updateRow);
                        $('#modalDeposit').modal('hide');

                        App.SweetAlert.showAlertSuccess("Deposit successfully!");

                        unbindAll();
                        handleGroupShowModal();

                    })
                    .fail((error) => {
                        App.SweetAlert.showAlertError("Deposit fail!")
                    })
            })

        }

        // ================================================================================================
        // ============================================ WITHDRAW ==========================================
        // ================================================================================================
        function handleShowWithdraw() {
            $('.withdraw').on('click', function () {
                let id = $(this).data('id');
                console.log(id);

                $.ajax({
                        "type": "GET",
                        "url": "http://localhost:3000/customers/" + id
                    })
                    .done((data) => {

                        $('#modalWithdraw').modal('show');

                        $('#customerIdWd').val(data.id);
                        $('#fullNameWd').val(data.fullName);
                        $('#balanceWd').val(data.balance);

                    })
                    .fail((error) => {
                        alert('fail');
                    })
            })
        }

        $('#frmWithdraw').validate({
            rules: {
                transactionAmountWd: {
                    required: true,
                    number: true,
                    greaterThanEqual: 50
                }
            },
            messages: {
                transactionAmountWd: {
                    required: "Please enter transaction amount.",
                    number: "Please enter only digit",
                    greaterThanEqual: "Withdrawal money must be greater than 50$"
                }
            },
            submitHandler: function () {
                doWithdraw();
            }
        })

        $('#btnWithdraw').on('click', () => {
            $('#frmWithdraw').submit();
        })

        function doWithdraw() {
            let customerId = $('#customerIdWd').val();
            let transactionAmount = +$('#transactionAmountWd').val();

            delete withdraw.id;
            withdraw.customerId = customerId;
            withdraw.transactionAmount = transactionAmount;
            withdraw.createdAt = new Date();
            withdraw.createdBy = 1;
            withdraw.updatedAt = new Date();
            withdraw.updatedBy = 1;
            withdraw.isDeleted = 0;

            if (transactionAmount <= customer.balance) {
                $.ajax({
                        headers: {
                            "type": "application/json",
                            "content-type": "application/json"
                        },
                        type: "POST",
                        url: "http://localhost:3000/withdraws",
                        data: JSON.stringify(withdraw)
                    })
                    .done((data) => {
                        console.log(data);
                    })
                    .fail((err) => {
                        alert("Withdraw fail")
                    })

                getCustomerById(customerId).then(function () {
                    customer.balance = Number(customer.balance) - Number(transactionAmount);
                    $.ajax({
                            headers: {
                                "type": "application/json",
                                "content-type": "application/json"
                            },
                            type: "PUT",
                            url: "http://localhost:3000/customers/" + customerId,
                            data: JSON.stringify(customer)
                        })
                        .done((item) => {
                            customer = item;
                            locationRegion = customer.locationRegion;

                            let currentRow = $('#tr_' + customer.id);
                            let updateRow = `
                        <tr id="tr_${customer.id}">
                            <td> 
                                <span class="select-tab unselected"></span>
                            </td>
                            <td>${customer.id}</td>
                            <td>${customer.fullName}</td>
                            <td>${customer.email}</td>
                            <td>${customer.phone}</td>                       
                            <td>${customer.balance}</td>
                            <td>${locationRegion.provinceName}</td>
                            <td>${locationRegion.districtName}</td>
                            <td>${locationRegion.wardName}</td>
                            <td>${locationRegion.address}</td>                   
                        </tr>
                `;

                            currentRow.replaceWith(updateRow);
                            $('#modalWithdraw').modal('hide');

                            App.SweetAlert.showAlertSuccess("Withdraw successfully!");

                            unbindAll();
                            handleGroupShowModal();

                        })
                        .fail((error) => {
                            App.SweetAlert.showAlertError("Withdraw fail!")
                        })
                })
            } else {
                App.SweetAlert.showAlertError("Transaction amount can not exceed current balance.")
            }
        }

        // ================================================================================================
        // ============================================ TRANSFER ==========================================
        // ================================================================================================

        function getSenderById(senderId) {
            return $.ajax({
                    "type": "GET",
                    "url": "http://localhost:3000/customers/" + senderId
                })
                .done((data) => {
                    sender = data;
                    console.log(data);
                })
                .fail((error) => {
                    App.SweetAlert.showAlertError('Invalid sender ID')
                })
        }

        function getRecipientById(recipientId) {
            return $.ajax({
                    "type": "GET",
                    "url": "http://localhost:3000/customers/" + recipientId
                })
                .done((data) => {
                    recipient = data;
                    console.log(data);
                })
                .fail((error) => {
                    App.SweetAlert.showAlertError('Invalid recipient ID')
                })
        }

        function handleShowTransfer() {
            $('.transfer').on('click', function () {
                let id = $(this).data('id');
                console.log(id);

                $.ajax({
                        type: "GET",
                        url: "http://localhost:3000/customers/" + id,
                    })
                    .done((data) => {

                        $('#modalTransfer').modal('show');

                        $('#senderIdTrf').val(data.id);
                        $('#senderNameTrf').val(data.fullName);
                        $('#emailTrf').val(data.email);
                        $('#balanceTrf').val(data.balance);

                        $.ajax({
                                type: "GET",
                                url: "http://localhost:3000/customers/?deleted=0"
                            })
                            .done((data) => {
                                $('#recipientIdTrf').html("");

                                $.each(data, (i, item) => {
                                    if (item.id != id) {
                                        let str = `
                                        <option value=${item.id}>(${item.id}) - ${item.fullName}</option>
                                    `;
                                        $('#recipientIdTrf').prepend(str);
                                    }
                                });
                            })
                    })
                    .fail((error) => {
                        alert('fail');
                    })
            })

            $('#transferAmountTrf').on("input", () => {
                let fee = Number($("#feesTrf").val());
                let transferAmount = Number($("#transferAmountTrf").val());
                $("#transactionAmountTrf").val((transferAmount * (1 + fee / 100)).toFixed(0));
            })
        }

        $('#frmTransfer').validate({

            rules: {
                transferAmountTrf: {
                    required: true,
                    number: true,
                    greaterThanEqual: 50
                }
            },
            messages: {
                transferAmountTrf: {
                    required: "Please enter transaction amount.",
                    number: "Please enter only digit",
                    greaterThanEqual: "Transfer amount must be greater than or equal $50"
                }
            },
            submitHandler: function () {
                doTransfer();
            }
        })

        $('#btnTransfer').on('click', () => {
            $('#frmTransfer').submit();

        })

        function doTransfer() {

            let senderId = $('#senderIdTrf').val();
            let recipientId = $('#recipientIdTrf').val();
            let senderName = $('#senderNameTrf').val();
            let email = $('#emailTrf').val();
            let balance = $('#balanceTrf').val();
            let fees = 10;
            let transferAmount = +$('#transferAmountTrf').val();
            let feesAmount = transferAmount * 0.1;
            let transactionAmount = transferAmount * 1.1;


            delete transfer.id;
            transfer.createdAt = new Date();
            transfer.createdBy = 1;
            transfer.updatedAt = new Date();
            transfer.updatedBy = 1;
            transfer.deleted = 0;
            transfer.fees = fees;
            transfer.feesAmount = feesAmount;
            transfer.transactionAmount = transactionAmount;
            transfer.transferAmount = transferAmount;
            transfer.senderId = senderId;
            transfer.recipientId = recipientId
            console.log(transfer);


            delete transferDTO.id;
            transferDTO.senderId = senderId;
            transferDTO.senderName = senderName;
            transferDTO.recipientId = recipientId;
            transferDTO.recipientName = recipient.fullName;
            transferDTO.transferAmount = transferAmount;
            transferDTO.fees = fees;
            transferDTO.feesAmount = feesAmount;

            $.ajax({
                    type: "GET",
                    url: "http://localhost:3000/customers/" + senderId,
                })
                .done((data) => {
                    sender = data;
                    console.log(sender);
                })

            if (senderId !== recipientId) {
                if (transactionAmount <= sender.balance) {
                    $.ajax({
                            headers: {
                                "type": "application/json",
                                "content-type": "application/json"
                            },
                            type: "POST",
                            url: "http://localhost:3000/transfers",
                            data: JSON.stringify(transfer)
                        })
                        .done((data) => {
                            console.log(data);

                        })
                        .fail((err) => {
                            alert("Transfer fail")
                        })

                    $.ajax({
                            headers: {
                                "type": "application/json",
                                "content-type": "application/json"
                            },
                            type: "POST",
                            url: "http://localhost:3000/transferDTOs",
                            data: JSON.stringify(transferDTO)
                        })
                        .done((data) => {
                            console.log(data);

                        })
                        .fail((err) => {
                            alert("Transfer fail")
                        })


                    getSenderById(senderId).then(function () {
                        sender.balance = Number(sender.balance) - Number(transactionAmount);
                        console.log("sender: " + sender);
                        $.ajax({
                                headers: {
                                    "type": "application/json",
                                    "content-type": "application/json"
                                },
                                type: "PUT",
                                url: "http://localhost:3000/customers/" + senderId,
                                data: JSON.stringify(sender)
                            })
                            .done((item) => {
                                sender = item;
                                locationRegion = sender.locationRegion;

                                let currentRow = $('#tr_' + sender.id);
                                let updateRow = `
                            <tr id="tr_${sender.id}">
                                <td> 
                                    <span class="select-tab unselected"></span>
                                </td>
                                <td>${sender.id}</td>
                                <td>${sender.fullName}</td>
                                <td>${sender.email}</td>
                                <td>${sender.phone}</td>                       
                                <td>${sender.balance}</td>
                                <td>${locationRegion.provinceName}</td>
                                <td>${locationRegion.districtName}</td>
                                <td>${locationRegion.wardName}</td>
                                <td>${locationRegion.address}</td>                   
                            </tr>
                    `;

                                currentRow.replaceWith(updateRow);
                                $('#modalTransfer').modal('hide');

                                App.SweetAlert.showAlertSuccess("Transfer successfully!");

                                unbindAll();
                                handleGroupShowModal();

                            })
                            .fail((error) => {
                                App.SweetAlert.showAlertError("Transfer fail!")
                            })
                    })

                    getRecipientById(recipientId).then(function () {
                        console.log("recipient: " + recipient);
                        recipient.balance = Number(recipient.balance) + Number(transferAmount);
                        $.ajax({
                                headers: {
                                    "type": "application/json",
                                    "content-type": "application/json"
                                },
                                type: "PUT",
                                url: "http://localhost:3000/customers/" + recipientId,
                                data: JSON.stringify(recipient)
                            })
                            .done((item) => {
                                recipient = item;
                                locationRegion = recipient.locationRegion;

                                let currentRow = $('#tr_' + recipient.id);
                                let updateRow = `
                            <tr id="tr_${recipient.id}">
                                <td> 
                                    <span class="select-tab unselected"></span>
                                </td>
                                <td>${recipient.id}</td>
                                <td>${recipient.fullName}</td>
                                <td>${recipient.email}</td>
                                <td>${recipient.phone}</td>                       
                                <td>${recipient.balance}</td>
                                <td>${locationRegion.provinceName}</td>
                                <td>${locationRegion.districtName}</td>
                                <td>${locationRegion.wardName}</td>
                                <td>${locationRegion.address}</td>                   
                            </tr>
                    `;
                                currentRow.replaceWith(updateRow);
                                $('#modalTransfer').modal('hide');

                                App.SweetAlert.showAlertSuccess("Transfer successfully!");

                                unbindAll();
                                handleGroupShowModal();

                            })
                            .fail((error) => {
                                App.SweetAlert.showAlertError("Transfer fail!")
                            })
                    })

                } else {
                    App.SweetAlert.showAlertError("Transaction amount can not exceed current balance.")
                }

            } else {
                App.SweetAlert.showAlertError("Sender and recipient must be different.")
            }
        }

        // ================================================================================================
        // ============================================ VALIDATE INPUT ====================================
        // ================================================================================================


        $.validator.addMethod('lessThanEqual', function (value, el, param) {
            return value <=
                param;
        });

        $.validator.addMethod('greaterThanEqual', function (value, el, param) {
            return value >=
                param;
        });


        $.validator.addMethod("emailNotExistsEdit", function (value, element) {
            $.ajax({
                    type: "GET",
                    headers: {
                        "Content-Type": "Application/json",
                        "Accept": "Application/json"
                    },
                    url: "http://localhost:3000/customers"
                })
                .done((data) => {
                    $.each(data, (i, item) => {
                        customers = data;                       
                    })
                 
                })

            let currentCustomer = customers.find(x => x.email == value && x.email != customer.email);
            return this.optional(element) || (currentCustomer == undefined);
        },
            "This email has already been registered"
        )


       
        
    </script>
</body>

</html>